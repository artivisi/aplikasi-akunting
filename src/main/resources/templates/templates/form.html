<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main}"
      lang="id">
<head>
    <title th:text="${isEdit} ? 'Edit Template' : (${isDuplicate} ? 'Duplikat Template' : 'Template Baru')">Template</title>
</head>
<body>
    <h1 id="page-title" layout:fragment="page-title" th:text="${isEdit} ? 'Edit Template' : (${isDuplicate} ? 'Duplikat Template' : 'Template Baru')">Template</h1>

    <div layout:fragment="content" class="h-full flex flex-col overflow-y-auto">
        <div class="max-w-4xl">
            <!-- Breadcrumb -->
            <nav class="flex items-center space-x-2 text-sm text-gray-500 mb-6">
                <a th:href="@{/templates}" class="hover:text-primary-600 transition-colors">Template Jurnal</a>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                <span class="text-gray-900" th:text="${isEdit} ? 'Edit Template' : (${isDuplicate} ? 'Duplikat Template' : 'Template Baru')">Template</span>
            </nav>

            <!-- Duplicate Notice -->
            <div th:if="${isDuplicate}" class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-semibold text-blue-800" th:text="'Menduplikat dari: ' + ${sourceTemplate?.templateName}">Menduplikat dari: Template</h3>
                        <p class="text-xs text-blue-600 mt-0.5">Silakan ubah nama dan konfigurasi sesuai kebutuhan</p>
                    </div>
                </div>
            </div>

            <!-- Main Form -->
            <form th:action="${isEdit} ? @{/templates/{id}(id=${template.id})} : @{/templates}" method="post"
                  x-data="templateForm"
                  x-init="init()"
                  data-testid="template-form">

                <!-- Template Info Section -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                    <div class="p-6 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Informasi Template</h2>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Template Name -->
                            <div class="md:col-span-2">
                                <label for="templateName" class="block text-sm font-medium text-gray-700 mb-1">
                                    Nama Template <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="templateName" name="templateName"
                                       x-model="templateName"
                                       th:value="${template?.templateName} ?: ${sourceTemplate?.templateName}"
                                       placeholder="Contoh: Pendapatan Jasa Konsultasi, Bayar Tagihan Listrik"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm"
                                       required>
                            </div>

                            <!-- Category -->
                            <div>
                                <label for="category" class="block text-sm font-medium text-gray-700 mb-1">
                                    Kategori <span class="text-red-500">*</span>
                                </label>
                                <select id="category" name="category" x-model="category"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm"
                                        required>
                                    <option value="">Pilih kategori</option>
                                    <option th:each="cat : ${categories}" th:value="${cat.name()}"
                                            th:text="${cat.name() == 'INCOME'} ? 'Pendapatan' : (${cat.name() == 'EXPENSE'} ? 'Pengeluaran' : (${cat.name() == 'PAYMENT'} ? 'Pembayaran' : (${cat.name() == 'RECEIPT'} ? 'Penerimaan' : (${cat.name() == 'TRANSFER'} ? 'Transfer' : 'Penyesuaian'))))">Category</option>
                                </select>
                            </div>

                            <!-- Cash Flow Type -->
                            <div>
                                <div class="flex items-center mb-1">
                                    <label for="cashFlow" class="block text-sm font-medium text-gray-700">
                                        Klasifikasi Arus Kas <span class="text-red-500">*</span>
                                    </label>
                                    <div x-data="showState" class="relative ml-1">
                                        <button type="button" @click="toggleShow" @click.outside="closeShow" class="text-gray-400 hover:text-gray-600">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                        </button>
                                        <div :class="{ 'hidden': !show }" class="absolute left-0 bottom-full mb-2 w-72 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-lg z-10">
                                            <p class="font-medium mb-2">Untuk Laporan Arus Kas:</p>
                                            <p><span class="text-green-300">Operasional:</span> Aktivitas bisnis utama (pendapatan, beban)</p>
                                            <p class="mt-1"><span class="text-blue-300">Investasi:</span> Pembelian/penjualan aset tetap</p>
                                            <p class="mt-1"><span class="text-purple-300">Pendanaan:</span> Modal, pinjaman, dividen</p>
                                            <div class="absolute left-3 bottom-0 transform translate-y-1/2 rotate-45 w-2 h-2 bg-gray-900"></div>
                                        </div>
                                    </div>
                                </div>
                                <select id="cashFlow" name="cashFlowCategory" x-model="cashFlowCategory"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm"
                                        required>
                                    <option th:each="cf : ${cashFlowCategories}" th:value="${cf.name()}"
                                            th:text="${cf.name() == 'OPERATING'} ? 'Aktivitas Operasional' : (${cf.name() == 'INVESTING'} ? 'Aktivitas Investasi' : 'Aktivitas Pendanaan')">Cash Flow</option>
                                </select>
                            </div>

                            <!-- Template Type -->
                            <div>
                                <div class="flex items-center mb-1">
                                    <label for="templateType" class="block text-sm font-medium text-gray-700">
                                        Tipe Template
                                    </label>
                                    <div x-data="showState" class="relative ml-1">
                                        <button type="button" @click="toggleShow" @click.outside="closeShow" class="text-gray-400 hover:text-gray-600">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                        </button>
                                        <div :class="{ 'hidden': !show }" class="absolute left-0 bottom-full mb-2 w-72 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-lg z-10">
                                            <p><span class="text-green-300">Sederhana:</span> Satu input jumlah, semua baris menggunakan nilai yang sama atau formula sederhana</p>
                                            <p class="mt-2"><span class="text-blue-300">Terperinci:</span> Input per baris jurnal, untuk transaksi dengan jumlah berbeda per akun</p>
                                            <div class="absolute left-3 bottom-0 transform translate-y-1/2 rotate-45 w-2 h-2 bg-gray-900"></div>
                                        </div>
                                    </div>
                                </div>
                                <select id="templateType" name="templateType" x-model="templateType"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm">
                                    <option th:each="tt : ${templateTypes}" th:value="${tt.name()}"
                                            th:text="${tt.name() == 'SIMPLE'} ? 'Sederhana (satu jumlah)' : 'Terperinci (jumlah per baris)'">Type</option>
                                </select>
                            </div>

                            <!-- Description -->
                            <div class="md:col-span-2">
                                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
                                    Deskripsi
                                </label>
                                <textarea id="description" name="description" rows="2"
                                          placeholder="Penjelasan tentang penggunaan template ini..."
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm resize-none"
                                          th:text="${template?.description} ?: ${sourceTemplate?.description}"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Badge -->
                    <div class="px-6 py-3 bg-gray-50 border-b border-gray-200">
                        <div class="flex items-center space-x-3 text-sm">
                            <span class="text-gray-600">Preview:</span>
                            <span :class="{ 'hidden': !category }" x-bind:class="getCategoryColor(category)" class="px-2 py-0.5 rounded-full text-xs font-medium" x-text="getCategoryLabel(category)"></span>
                            <span :class="{ 'hidden': !cashFlowCategory }" class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-700" x-text="getCashFlowLabel(cashFlowCategory)"></span>
                            <span :class="{ 'hidden': templateType !== 'DETAILED' }" class="px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700">Terperinci</span>
                        </div>
                    </div>
                </div>

                <!-- Journal Lines Configuration -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold text-gray-900">Konfigurasi Jurnal</h2>
                            <button type="button" @click="addLine()"
                                    data-testid="btn-add-line"
                                    class="px-3 py-1.5 text-xs font-medium text-primary-700 bg-primary-50 rounded-lg hover:bg-primary-100 transition-colors">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    Tambah Baris
                                </span>
                            </button>
                        </div>

                        <!-- Preview Amount Input -->
                        <div class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="flex items-center space-x-3">
                                <label class="text-sm font-medium text-gray-700 whitespace-nowrap">Preview dengan:</label>
                                <div class="relative flex-1 max-w-xs">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-sm text-gray-500">Rp</span>
                                    <input type="text" x-model="previewAmount"
                                           @input="formatPreviewAmount(); updateAllPreviews();"
                                           class="w-full pl-10 pr-3 py-1.5 text-sm font-mono border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-right"
                                           placeholder="10.000.000">
                                </div>
                                <span class="text-xs text-gray-500">Lihat hasil formula di kolom Preview</span>
                            </div>
                        </div>

                        <!-- Help for formulas - comprehensive documentation -->
                        <div th:replace="~{fragments/formula-help :: formula-help}"></div>

                        <!-- Journal Lines Table -->
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <!-- Table Header -->
                            <div class="grid grid-cols-12 gap-2 px-4 py-2 bg-gray-100 text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <div class="col-span-3">Akun</div>
                                <div class="col-span-2 text-center">Posisi</div>
                                <div class="col-span-2">Formula</div>
                                <div class="col-span-2 text-right">Preview</div>
                                <div class="col-span-1 text-center">?</div>
                                <div class="col-span-2 text-center">Aksi</div>
                            </div>

                            <!-- Journal Lines -->
                            <template x-for="(line, index) in journalLines" :key="line.id">
                                <div class="grid grid-cols-12 gap-2 px-4 py-3 border-t border-gray-100 items-start">
                                    <!-- Account Selection -->
                                    <div class="col-span-3">
                                        <select x-model="line.accountId"
                                                data-testid="line-account-0"
                                                :name="lineName(index, 'accountId')"
                                                @change="setDynamic(line)"
                                                class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                            <option value="">[ Pilih saat transaksi ]</option>
                                            <option th:each="account : ${accounts}"
                                                    th:value="${account.id}"
                                                    th:text="${account.accountCode + ' - ' + account.accountName}">Account</option>
                                        </select>
                                        <!-- Account Hint (shown when account is not selected) -->
                                        <input :class="{ 'hidden': hasAccountId(line) }"
                                               type="text"
                                               x-model="line.accountHint"
                                               :name="lineName(index, 'accountHint')"
                                               placeholder="Hint: Bank/Kas, Akun Beban, dll"
                                               class="w-full px-2 py-1 text-xs border border-blue-300 rounded mt-1 bg-blue-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <input type="hidden" :name="lineName(index, 'lineOrder')" :value="lineOrder(index)">
                                    </div>

                                    <!-- Position (Debit/Credit) -->
                                    <div class="col-span-2 flex justify-center">
                                        <input type="hidden" :name="lineName(index, 'position')" x-model="line.position">
                                        <div class="inline-flex rounded-lg border border-gray-300 overflow-hidden">
                                            <button type="button"
                                                    :id="lineDebitBtnId(index)"
                                                    :data-testid="lineDebitBtnId(index)"
                                                    @click="setPositionDebit(line)"
                                                    :class="debitBtnClass(line)"
                                                    class="px-2 py-1 text-xs font-medium transition-colors">
                                                D
                                            </button>
                                            <button type="button"
                                                    :id="lineCreditBtnId(index)"
                                                    :data-testid="lineCreditBtnId(index)"
                                                    @click="setPositionCredit(line)"
                                                    :class="creditBtnClass(line)"
                                                    class="px-2 py-1 text-xs font-medium border-l border-gray-300 transition-colors">
                                                K
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Formula Input -->
                                    <div class="col-span-2">
                                        <input type="text" x-model="line.formula"
                                               @input="updateLinePreview(index)"
                                               :name="lineName(index, 'formula')"
                                               placeholder="amount"
                                               class="w-full px-2 py-1.5 text-xs font-mono border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                    </div>

                                    <!-- Preview Result -->
                                    <div class="col-span-2 text-right">
                                        <template x-if="showPreviewLoading(line)">
                                            <span class="text-xs text-gray-400">...</span>
                                        </template>
                                        <template x-if="showPreviewError(line)">
                                            <span class="text-xs text-red-500" :title="line.previewError">Error</span>
                                        </template>
                                        <template x-if="showPreviewResult(line)">
                                            <span class="text-xs font-mono text-gray-700" x-text="line.previewResult"></span>
                                        </template>
                                        <template x-if="showPreviewEmpty(line)">
                                            <span class="text-xs text-gray-400">-</span>
                                        </template>
                                    </div>

                                    <!-- Dynamic Indicator -->
                                    <div class="col-span-1 flex justify-center">
                                        <span :class="{ 'hidden': hasAccountId(line) }"
                                              class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-700 font-bold text-xs"
                                              title="Akun dipilih saat input transaksi">
                                            ?
                                        </span>
                                    </div>

                                    <!-- Actions -->
                                    <div class="col-span-2 flex justify-center space-x-2">
                                        <button type="button"
                                                @click="moveUp(index)"
                                                :disabled="index === 0"
                                                :class="moveUpBtnClass(index)"
                                                class="p-1 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                                            </svg>
                                        </button>
                                        <button type="button"
                                                @click="moveDown(index)"
                                                :disabled="isLastLine(index)"
                                                :class="moveDownBtnClass(index)"
                                                class="p-1 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                            </svg>
                                        </button>
                                        <button type="button" @click="removeLine(line.id)"
                                                :disabled="!canRemoveLine"
                                                :class="removeBtnClass()"
                                                class="p-1 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </template>

                            <!-- Summary -->
                            <div class="px-4 py-3 bg-gray-50 border-t border-gray-200">
                                <div class="flex items-center justify-between text-sm">
                                    <div class="flex items-center space-x-4">
                                        <span class="text-gray-600">Total baris: <span class="font-medium text-gray-900" x-text="lineCount"></span></span>
                                        <span class="text-gray-400">|</span>
                                        <span class="text-gray-600">Debit: <span class="font-medium text-gray-900" x-text="debitCount"></span></span>
                                        <span class="text-gray-600">Kredit: <span class="font-medium text-gray-900" x-text="creditCount"></span></span>
                                    </div>
                                    <div class="flex items-center text-xs">
                                        <template x-if="hasDebitAndCredit">
                                            <span class="flex items-center text-accent-700">
                                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                </svg>
                                                Struktur valid
                                            </span>
                                        </template>
                                        <template x-if="!hasDebitAndCredit">
                                            <span class="flex items-center text-amber-600">
                                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                                </svg>
                                                Perlu minimal 1 debit dan 1 kredit
                                            </span>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Settings -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                    <div class="p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Pengaturan Tambahan</h2>

                        <div class="space-y-4">
                            <!-- Active Status (only for edit) -->
                            <div th:if="${isEdit}" class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="text-sm font-medium text-gray-700">Status Template</p>
                                    <p class="text-xs text-gray-500">Template non-aktif tidak akan muncul di pilihan transaksi</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" name="isActive" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
                                    <span class="ms-3 text-sm font-medium text-gray-700">Aktif</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
                    <div class="flex items-center justify-between">
                        <a th:href="@{/templates}"
                           class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 transition-colors">
                            Batal
                        </a>
                        <div class="flex items-center space-x-3">
                            <!-- Preview Button -->
                            <button type="button" id="btn-preview" @click="showPreview()"
                                    :disabled="!isValidForPreview()"
                                    :class="previewBtnClass()"
                                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg transition-colors">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                    </svg>
                                    Preview
                                </span>
                            </button>

                            <!-- Save Button -->
                            <button id="btn-simpan" type="submit"
                                    class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 transition-colors">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    <th:block th:if="${isEdit}">Simpan Perubahan</th:block>
                                    <th:block th:unless="${isEdit}">Simpan Template</th:block>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <th:block layout:fragment="scripts">
    <script th:replace="~{fragments/formula-help :: formula-help-script}" th:attr="nonce=${cspNonce}"></script>
    <script th:inline="javascript" th:attr="nonce=${cspNonce}">
        function templateForm() {
            return {
                templateName: '',
                category: '',
                cashFlowCategory: 'OPERATING',
                templateType: 'SIMPLE',
                journalLines: [],
                nextLineId: 1,
                previewAmount: '10.000.000',
                previewDebounceTimers: {},

                // CSP-safe getters to replace inline expressions
                get lineCount() {
                    return this.journalLines ? this.journalLines.length : 0;
                },
                get debitCount() {
                    return this.journalLines ? this.journalLines.filter(l => l.position === 'DEBIT').length : 0;
                },
                get creditCount() {
                    return this.journalLines ? this.journalLines.filter(l => l.position === 'CREDIT').length : 0;
                },
                get hasDebitAndCredit() {
                    return this.debitCount > 0 && this.creditCount > 0;
                },
                get canRemoveLine() {
                    return this.lineCount > 2;
                },
                isLastLine(index) {
                    return index === this.lineCount - 1;
                },
                canMoveDown(index) {
                    return index < this.lineCount - 1;
                },

                moveUp(index) {
                    if (index > 0) {
                        const temp = this.journalLines[index];
                        this.journalLines[index] = this.journalLines[index - 1];
                        this.journalLines[index - 1] = temp;
                    }
                },

                moveDown(index) {
                    if (this.canMoveDown(index)) {
                        const temp = this.journalLines[index];
                        this.journalLines[index] = this.journalLines[index + 1];
                        this.journalLines[index + 1] = temp;
                    }
                },

                // CSP-safe methods for field name generation
                lineName(index, field) {
                    return 'lines[' + index + '].' + field;
                },
                lineDebitBtnId(index) {
                    return 'btn-debit-' + index;
                },
                lineCreditBtnId(index) {
                    return 'btn-credit-' + index;
                },
                lineOrder(index) {
                    return index + 1;
                },

                // CSP-safe methods for line operations
                setDynamic(line) {
                    if (line) line.isDynamic = (line.accountId === '');
                },
                setPositionDebit(line) {
                    if (line) line.position = 'DEBIT';
                },
                setPositionCredit(line) {
                    if (line) line.position = 'CREDIT';
                },
                isDebit(line) {
                    return line && line.position === 'DEBIT';
                },
                isCredit(line) {
                    return line && line.position === 'CREDIT';
                },
                debitBtnClass(line) {
                    return this.isDebit(line) ? 'bg-primary-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50';
                },
                creditBtnClass(line) {
                    return this.isCredit(line) ? 'bg-primary-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50';
                },
                moveUpBtnClass(index) {
                    return index === 0 ? 'text-gray-300 cursor-not-allowed' : 'text-gray-500 hover:text-gray-700';
                },
                moveDownBtnClass(index) {
                    return this.isLastLine(index) ? 'text-gray-300 cursor-not-allowed' : 'text-gray-500 hover:text-gray-700';
                },
                removeBtnClass() {
                    return !this.canRemoveLine ? 'text-gray-300 cursor-not-allowed' : 'text-red-500 hover:text-red-700';
                },
                previewBtnClass() {
                    return !this.isValidForPreview() ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50';
                },

                // CSP-safe methods for complex expressions
                hasAccountId(line) {
                    return line && line.accountId && line.accountId !== '';
                },
                showPreviewLoading(line) {
                    return line && line.previewLoading;
                },
                showPreviewError(line) {
                    return line && !line.previewLoading && line.previewError;
                },
                showPreviewResult(line) {
                    return line && !line.previewLoading && !line.previewError && line.previewResult;
                },
                showPreviewEmpty(line) {
                    return line && !line.previewLoading && !line.previewError && !line.previewResult;
                },

                formatPreviewAmount() {
                    let value = this.previewAmount.replace(/\D/g, '');
                    this.previewAmount = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                },

                parsePreviewAmount() {
                    return parseInt(this.previewAmount.replace(/\./g, ''), 10) || 0;
                },

                updateAllPreviews() {
                    for (let i = 0; i < this.journalLines.length; i++) {
                        this.updateLinePreview(i);
                    }
                },

                updateLinePreview(index) {
                    const line = this.journalLines[index];
                    if (!line) return;

                    // Clear existing timer for this line
                    if (this.previewDebounceTimers[index]) {
                        clearTimeout(this.previewDebounceTimers[index]);
                    }

                    // Debounce the API call
                    this.previewDebounceTimers[index] = setTimeout(() => {
                        this.fetchLinePreview(index);
                    }, 300);
                },

                async fetchLinePreview(index) {
                    const line = this.journalLines[index];
                    if (!line || !line.formula) {
                        line.previewResult = null;
                        line.previewError = null;
                        return;
                    }

                    const amount = this.parsePreviewAmount();
                    if (amount === 0) {
                        line.previewResult = null;
                        line.previewError = null;
                        return;
                    }

                    line.previewLoading = true;
                    line.previewError = null;

                    try {
                        const response = await fetch('/templates/api/formula/preview', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ formula: line.formula, amount: amount })
                        });

                        const data = await response.json();

                        if (data.valid) {
                            line.previewResult = data.formattedResult;
                            line.previewError = null;
                        } else {
                            line.previewResult = null;
                            line.previewError = data.errors.join(', ');
                        }
                    } catch (error) {
                        line.previewError = 'Error';
                        line.previewResult = null;
                    } finally {
                        line.previewLoading = false;
                    }
                },

                init() {
                    /*<![CDATA[*/
                    const isEdit = /*[[${isEdit}]]*/ false;
                    const isDuplicate = /*[[${isDuplicate}]]*/ false;

                    if (isEdit || isDuplicate) {
                        this.templateName = /*[[${template?.templateName ?: (sourceTemplate?.templateName ?: '')}]]*/ '';
                        this.category = /*[[${template?.category?.name() ?: (sourceTemplate?.category?.name() ?: '')}]]*/ '';
                        this.cashFlowCategory = /*[[${template?.cashFlowCategory?.name() ?: (sourceTemplate?.cashFlowCategory?.name() ?: 'OPERATING')}]]*/ 'OPERATING';
                        this.templateType = /*[[${template?.templateType?.name() ?: (sourceTemplate?.templateType?.name() ?: 'SIMPLE')}]]*/ 'SIMPLE';

                        // Load existing lines from server-rendered data
                        const templateLines = [
                            /*[# th:each="line, iterStat : ${template != null ? template.lines : (sourceTemplate != null ? sourceTemplate.lines : {})}" ]*/
                            {
                                id: /*[[${iterStat.index + 1}]]*/ 1,
                                accountId: /*[[${line.account?.id ?: ''}]]*/ '',
                                position: /*[[${line.position?.name() ?: 'DEBIT'}]]*/ 'DEBIT',
                                formula: /*[[${line.formula ?: 'amount'}]]*/ 'amount',
                                accountHint: /*[[${line.accountHint ?: ''}]]*/ '',
                                previewResult: null,
                                previewError: null,
                                previewLoading: false
                            },
                            /*[/]*/
                        ];

                        // Filter out empty placeholder objects
                        this.journalLines = templateLines.filter(line => line.id && (line.accountId || line.formula));

                        if (this.journalLines.length > 0) {
                            this.nextLineId = this.journalLines.length + 1;
                            // Initial preview for loaded lines
                            this.$nextTick(() => this.updateAllPreviews());
                        } else {
                            this.addDefaultLines();
                        }
                    } else {
                        this.addDefaultLines();
                    }
                    /*]]>*/
                },

                addDefaultLines() {
                    this.journalLines = [
                        { id: 1, accountId: '', position: 'DEBIT', formula: 'amount', accountHint: '', previewResult: null, previewError: null, previewLoading: false },
                        { id: 2, accountId: '', position: 'CREDIT', formula: 'amount', accountHint: '', previewResult: null, previewError: null, previewLoading: false }
                    ];
                    this.nextLineId = 3;
                    // Initial preview
                    this.$nextTick(() => this.updateAllPreviews());
                },

                addLine() {
                    this.journalLines.push({
                        id: this.nextLineId++,
                        accountId: '',
                        position: 'DEBIT',
                        formula: 'amount',
                        accountHint: '',
                        previewResult: null,
                        previewError: null,
                        previewLoading: false
                    });
                    // Preview the new line
                    this.$nextTick(() => this.updateLinePreview(this.journalLines.length - 1));
                },

                removeLine(id) {
                    if (this.journalLines.length > 2) {
                        this.journalLines = this.journalLines.filter(l => l.id !== id);
                    }
                },

                getCategoryColor(cat) {
                    const colors = {
                        'INCOME': 'bg-green-100 text-green-800',
                        'EXPENSE': 'bg-red-100 text-red-800',
                        'PAYMENT': 'bg-blue-100 text-blue-800',
                        'RECEIPT': 'bg-cyan-100 text-cyan-800',
                        'TRANSFER': 'bg-purple-100 text-purple-800',
                        'ADJUSTMENT': 'bg-amber-100 text-amber-800'
                    };
                    return colors[cat] || 'bg-gray-100 text-gray-800';
                },

                getCategoryLabel(cat) {
                    const labels = {
                        'INCOME': 'Pendapatan',
                        'EXPENSE': 'Pengeluaran',
                        'PAYMENT': 'Pembayaran',
                        'RECEIPT': 'Penerimaan',
                        'TRANSFER': 'Transfer',
                        'ADJUSTMENT': 'Penyesuaian'
                    };
                    return labels[cat] || cat;
                },

                getCashFlowLabel(cf) {
                    const labels = {
                        'OPERATING': 'Operasional',
                        'INVESTING': 'Investasi',
                        'FINANCING': 'Pendanaan'
                    };
                    return labels[cf] || cf;
                },

                isValidForPreview() {
                    // Check if all required fields are filled
                    if (!this.templateName || !this.category || !this.cashFlowCategory) {
                        return false;
                    }
                    // Check if there's at least one debit and one credit line
                    const hasDebit = this.journalLines.some(l => l.position === 'DEBIT' && l.accountId);
                    const hasCredit = this.journalLines.some(l => l.position === 'CREDIT' && l.accountId);
                    return hasDebit && hasCredit;
                },

                async showPreview() {
                    if (!this.isValidForPreview()) {
                        alert('Mohon lengkapi semua field yang diperlukan');
                        return;
                    }

                    const amount = this.parsePreviewAmount();
                    if (amount === 0) {
                        alert('Mohon masukkan jumlah preview yang valid');
                        return;
                    }

                    // Show loading state
                    const previewBtn = document.querySelector('button[type="button"][\\@click*="showPreview"]');
                    const originalHTML = previewBtn?.innerHTML;
                    if (previewBtn) {
                        previewBtn.disabled = true;
                        previewBtn.innerHTML = '<span class="flex items-center"><svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Memuat...</span>';
                    }

                    try {
                        // Build preview request
                        const previewData = {
                            transactionDate: new Date().toISOString().split('T')[0],
                            amount: amount,
                            description: 'Preview: ' + this.templateName
                        };

                        // Create temporary template data
                        const templateData = {
                            templateName: this.templateName,
                            category: this.category,
                            cashFlowCategory: this.cashFlowCategory,
                            templateType: this.templateType,
                            description: document.getElementById('description').value,
                            active: true,
                            lines: this.journalLines
                                .filter(line => line.accountId) // Only include lines with accounts
                                .map((line, index) => ({
                                    accountId: line.accountId,
                                    position: line.position,
                                    formula: line.formula,
                                    lineOrder: index + 1,
                                    description: ''
                                }))
                        };

                        // First, create temporary template via API
                        const createResponse = await fetch('/templates/api', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(templateData)
                        });

                        if (!createResponse.ok) {
                            throw new Error('Gagal membuat preview template');
                        }

                        const createdTemplate = await createResponse.json();

                        // Then get preview using the created template
                        const previewResponse = await fetch(`/templates/api/${createdTemplate.id}/preview`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(previewData)
                        });

                        if (!previewResponse.ok) {
                            throw new Error('Gagal mendapatkan preview');
                        }

                        const previewResult = await previewResponse.json();

                        // Clean up temporary template
                        await fetch(`/templates/api/${createdTemplate.id}`, {
                            method: 'DELETE'
                        });

                        // Display preview result
                        this.displayPreviewResult(previewResult);

                    } catch (error) {
                        console.error('Preview error:', error);
                        alert('Gagal menampilkan preview: ' + error.message);
                    } finally {
                        // Restore button state
                        if (previewBtn && originalHTML) {
                            previewBtn.disabled = false;
                            previewBtn.innerHTML = originalHTML;
                        }
                    }
                },

                displayPreviewResult(result) {
                    if (!result.valid) {
                        alert('Preview gagal: ' + (result.errors?.join(', ') || 'Unknown error'));
                        return;
                    }

                    // Format the preview data as a table
                    const lines = result.entries || [];
                    // Escape user-controlled data to prevent XSS
                    const templateName = this.escapeHtml(this.templateName);
                    const previewAmount = this.escapeHtml(String(this.previewAmount));
                    
                    let html = `
                        <div class="fixed inset-0 z-50 overflow-y-auto bg-black/50" id="previewModal">
                            <div class="flex items-center justify-center min-h-screen px-4">
                                <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 id="preview-modal-title" class="text-lg font-semibold text-gray-900">Preview Template: ${templateName}</h3>
                                        <button type="button" id="btn-preview-close-x" onclick="document.getElementById('previewModal').remove()" class="text-gray-400 hover:text-gray-600">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div id="preview-amount-display" class="mb-4 text-sm text-gray-600">
                                        <p>Jumlah: <span class="font-mono font-semibold">Rp ${previewAmount}</span></p>
                                    </div>
                                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                                        <table id="preview-table" class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th id="th-akun" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Akun</th>
                                                    <th id="th-debit" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Debit</th>
                                                    <th id="th-kredit" class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Kredit</th>
                                                </tr>
                                            </thead>
                                            <tbody id="preview-tbody" class="bg-white divide-y divide-gray-100">
                    `;

                    let totalDebit = 0;
                    let totalCredit = 0;

                    lines.forEach(line => {
                        // Escape account data to prevent XSS from stored malicious data
                        const accountCode = this.escapeHtml(line.accountCode || '?');
                        const accountName = this.escapeHtml(line.accountName || 'Akun tidak tersedia');
                        const debit = line.debitAmount || 0;
                        const credit = line.creditAmount || 0;
                        totalDebit += debit;
                        totalCredit += credit;

                        html += `
                            <tr>
                                <td class="px-4 py-2 text-sm text-gray-900">${accountCode} - ${accountName}</td>
                                <td class="px-4 py-2 text-sm text-right font-mono">${debit > 0 ? this.formatNumber(debit) : '-'}</td>
                                <td class="px-4 py-2 text-sm text-right font-mono">${credit > 0 ? this.formatNumber(credit) : '-'}</td>
                            </tr>
                        `;
                    });

                    html += `
                                            </tbody>
                                            <tfoot id="preview-tfoot" class="bg-gray-50 font-semibold">
                                                <tr>
                                                    <td class="px-4 py-2 text-sm text-gray-900">Total</td>
                                                    <td id="preview-total-debit" class="px-4 py-2 text-sm text-right font-mono text-gray-900">${this.formatNumber(totalDebit)}</td>
                                                    <td id="preview-total-kredit" class="px-4 py-2 text-sm text-right font-mono text-gray-900">${this.formatNumber(totalCredit)}</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                    <div id="preview-balance-status" class="mt-4 flex items-center ${totalDebit === totalCredit ? 'text-green-600' : 'text-red-600'}">
                                        ${totalDebit === totalCredit
                                            ? '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg><span class="text-sm font-medium">Jurnal seimbang</span>'
                                            : '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><span class="text-sm font-medium">Jurnal tidak seimbang! Debit: ' + this.formatNumber(totalDebit) + ', Kredit: ' + this.formatNumber(totalCredit) + '</span>'}
                                    </div>
                                    <div class="mt-6 flex justify-end">
                                        <button type="button" id="btn-preview-close" onclick="document.getElementById('previewModal').remove()" class="px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700">
                                            Tutup
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Append to body
                    const div = document.createElement('div');
                    div.innerHTML = html;
                    document.body.appendChild(div.firstElementChild);
                },

                formatNumber(num) {
                    return new Intl.NumberFormat('id-ID').format(num);
                },

                // Escape HTML to prevent XSS attacks
                escapeHtml(text) {
                    if (text == null) return '';
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
            };
        }

        // Register the component for CSP compatibility
        document.addEventListener('alpine:init', () => {
            Alpine.data('templateForm', templateForm);
        });
    </script>
    </th:block>
</body>
</html>
