<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main}"
      lang="id">
<head>
    <title>Eksekusi Template</title>
</head>
<body>
    <h1 id="page-title" layout:fragment="page-title">Eksekusi Template</h1>

    <div id="execute-content" layout:fragment="content" class="h-full flex flex-col overflow-y-auto">
        <div class="max-w-4xl" x-data="templateExecution()">
            <!-- Breadcrumb -->
            <nav class="flex items-center space-x-2 text-sm text-gray-500 mb-6">
                <a th:href="@{/templates}" class="hover:text-primary-600 transition-colors">Template Jurnal</a>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                <a th:href="@{/templates/{id}(id=${template.id})}" class="hover:text-primary-600 transition-colors" th:text="${template.templateName}">Template Name</a>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                <span class="text-gray-900">Eksekusi</span>
            </nav>

            <!-- Template Info -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6 p-4">
                <div class="flex items-center">
                    <span class="w-10 h-10 rounded-full flex items-center justify-center mr-3"
                          th:classappend="${template.category.name() == 'INCOME'} ? 'bg-green-100' :
                                           (${template.category.name() == 'EXPENSE'} ? 'bg-red-100' :
                                           (${template.category.name() == 'TRANSFER'} ? 'bg-blue-100' : 'bg-gray-100'))">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                             th:classappend="${template.category.name() == 'INCOME'} ? 'text-green-600' :
                                              (${template.category.name() == 'EXPENSE'} ? 'text-red-600' :
                                              (${template.category.name() == 'TRANSFER'} ? 'text-blue-600' : 'text-gray-600'))">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </span>
                    <div>
                        <h2 id="template-name" class="text-lg font-semibold text-gray-900" th:text="${template.templateName}">Template Name</h2>
                        <p class="text-sm text-gray-500" th:text="${template.description}">Description</p>
                    </div>
                </div>
            </div>

            <!-- Execution Form -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Input Transaksi</h2>
                    <p class="text-sm text-gray-500 mt-1">Masukkan data transaksi untuk membuat jurnal dari template ini</p>
                </div>

                <div class="p-6">
                    <input type="hidden" id="template-id" th:value="${template.id}">
                    <input type="hidden" id="is-detailed" th:value="${isDetailedTemplate}">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="transactionDate" class="block text-sm font-medium text-gray-700 mb-1">
                                Tanggal Transaksi <span class="text-red-500">*</span>
                            </label>
                            <input type="date" id="transactionDate" name="transactionDate" x-model="form.transactionDate"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        </div>

                        <!-- Amount field for SIMPLE templates -->
                        <div th:if="${!isDetailedTemplate}">
                            <label id="label-amount" for="amount" class="block text-sm font-medium text-gray-700 mb-1">
                                Jumlah <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">Rp</span>
                                <input type="text" id="amount" name="amount" x-model="form.amountDisplay"
                                       @input="formatAmount()"
                                       class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-right font-mono"
                                       placeholder="0">
                            </div>
                        </div>

                        <div class="md:col-span-2">
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
                                Keterangan <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="description" name="description" x-model="form.description"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                   placeholder="Masukkan keterangan transaksi">
                        </div>
                    </div>

                    <!-- Dynamic Account Selection -->
                    <div th:if="${hasDynamicAccounts}" class="mt-6">
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">Pilih Akun</h3>
                        <p class="text-xs text-gray-500 mb-3">Pilih akun untuk baris jurnal yang memerlukan pemilihan akun saat transaksi</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div th:each="dal : ${dynamicAccountLines}" class="relative">
                                <label th:for="${'account_' + dal.lineOrder()}" class="block text-xs font-medium text-gray-600 mb-1">
                                    <span th:text="${dal.hint()}">Pilih akun</span>
                                    <span th:classappend="${dal.position() == 'DEBIT'} ? 'text-red-600' : 'text-green-600'"
                                          th:text="${dal.position() == 'DEBIT' ? '(Debit)' : '(Kredit)'}"></span>
                                    <span class="text-red-500">*</span>
                                </label>
                                <select th:id="${'account_' + dal.lineOrder()}"
                                        th:name="${'account_' + dal.lineOrder()}"
                                        th:data-line-order="${dal.lineOrder()}"
                                        class="account-select w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                        required>
                                    <option value="">-- Pilih Akun --</option>
                                    <option th:each="account : ${accounts}"
                                            th:value="${account.id}"
                                            th:text="${account.accountCode + ' - ' + account.accountName}">Account</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Variable inputs for DETAILED templates -->
                    <div th:if="${isDetailedTemplate}" class="mt-6">
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">Saldo per Akun</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto p-1">
                            <div th:each="fv : ${formulaVariables}" class="relative">
                                <label th:for="${'var_' + fv.name()}" class="block text-xs font-medium text-gray-600 mb-1 truncate" th:text="${fv.label()}" th:title="${fv.label()}">Variable Label</label>
                                <div class="relative">
                                    <span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">Rp</span>
                                    <input type="text"
                                           th:id="${'var_' + fv.name()}"
                                           th:name="${'var_' + fv.name()}"
                                           th:data-var-name="${fv.name()}"
                                           class="var-input w-full pl-8 pr-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-primary-500 focus:border-primary-500 text-right font-mono"
                                           placeholder="0"
                                           @input="formatVariableInput($event)">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-end space-x-3 mt-6">
                        <button type="button" id="btn-preview" @click="previewExecution()"
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                                :disabled="loading">
                            <span class="flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                Preview
                            </span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Preview Section -->
            <div x-show="preview" x-cloak class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                <div class="p-6 border-b border-gray-200 bg-blue-50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                            <h2 class="text-lg font-semibold text-blue-900">Preview Jurnal</h2>
                        </div>
                        <span class="text-sm text-blue-700">Belum disimpan</span>
                    </div>
                </div>

                <div class="p-6">
                    <!-- Preview Table -->
                    <table class="w-full text-sm" id="preview-table">
                        <thead>
                            <tr class="text-left text-xs font-semibold text-gray-600 uppercase tracking-wider border-b">
                                <th class="pb-3">Akun</th>
                                <th class="pb-3 text-right">Debit</th>
                                <th class="pb-3 text-right">Kredit</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="(entry, index) in previewData.entries" :key="index">
                                <tr class="preview-row">
                                    <td class="py-3">
                                        <div class="flex items-center">
                                            <span class="w-8 h-8 rounded bg-gray-50 flex items-center justify-center mr-2">
                                                <span class="text-xs font-mono text-gray-600 account-code" x-text="entry.accountCode"></span>
                                            </span>
                                            <span class="account-name" x-text="entry.accountName"></span>
                                        </div>
                                    </td>
                                    <td class="py-3 text-right font-mono debit-amount" x-text="formatNumber(entry.debitAmount)"></td>
                                    <td class="py-3 text-right font-mono credit-amount" x-text="formatNumber(entry.creditAmount)"></td>
                                </tr>
                            </template>
                        </tbody>
                        <tfoot class="border-t-2 border-gray-300">
                            <tr class="font-semibold">
                                <td class="pt-3">Total</td>
                                <td id="total-debit" class="pt-3 text-right font-mono" x-text="formatNumber(previewData.totalDebit)"></td>
                                <td id="total-credit" class="pt-3 text-right font-mono" x-text="formatNumber(previewData.totalCredit)"></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Balance Check -->
                    <div class="mt-4 p-3 rounded-lg"
                         :class="previewData.totalDebit === previewData.totalCredit ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
                        <div class="flex items-center"
                             :class="previewData.totalDebit === previewData.totalCredit ? 'text-green-700' : 'text-red-700'">
                            <svg x-show="previewData.totalDebit === previewData.totalCredit" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <svg x-show="previewData.totalDebit !== previewData.totalCredit" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span id="balance-status" x-text="previewData.totalDebit === previewData.totalCredit ? 'Jurnal Balance: Debit = Kredit' : 'Jurnal Tidak Balance!'"></span>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex items-center justify-end space-x-3 mt-6">
                        <button type="button" @click="preview = false"
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            Batal
                        </button>
                        <button type="button" id="btn-execute" @click="executeTemplate()"
                                class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 transition-colors"
                                :disabled="loading || previewData.totalDebit !== previewData.totalCredit">
                            <span class="flex items-center">
                                <svg x-show="loading" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <svg x-show="!loading" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <span x-text="loading ? 'Menyimpan...' : 'Buat Jurnal'"></span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Error Section -->
            <div x-show="error" x-cloak class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <div class="flex items-start">
                    <svg class="w-5 h-5 text-red-600 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div>
                        <h4 class="text-sm font-semibold text-red-800">Terjadi Kesalahan</h4>
                        <p id="error-message" class="text-sm text-red-700 mt-1" x-text="errorMessage"></p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="flex items-center justify-between mb-8">
                <a th:href="@{/templates/{id}(id=${template.id})}" class="inline-flex items-center text-sm text-gray-600 hover:text-gray-900 transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    Kembali ke Detail Template
                </a>
            </div>
        </div>
    </div>

    <script layout:fragment="scripts">
        function templateExecution() {
            return {
                form: {
                    transactionDate: new Date().toISOString().split('T')[0],
                    amount: 0,
                    amountDisplay: '',
                    description: ''
                },
                isDetailed: document.getElementById('is-detailed')?.value === 'true',
                preview: false,
                previewData: {
                    entries: [],
                    totalDebit: 0,
                    totalCredit: 0
                },
                loading: false,
                error: false,
                errorMessage: '',

                formatAmount() {
                    let value = this.form.amountDisplay.replace(/[^0-9]/g, '');
                    this.form.amount = parseInt(value) || 0;
                    this.form.amountDisplay = this.formatNumber(this.form.amount);
                },

                formatVariableInput(event) {
                    let value = event.target.value.replace(/[^0-9]/g, '');
                    let numValue = parseInt(value) || 0;
                    event.target.value = this.formatNumber(numValue);
                    event.target.dataset.numValue = numValue;
                },

                formatNumber(num) {
                    if (!num || num === 0) return '0';
                    return new Intl.NumberFormat('id-ID').format(num);
                },

                collectVariables() {
                    const variables = {};
                    document.querySelectorAll('.var-input').forEach(input => {
                        const varName = input.dataset.varName;
                        const numValue = parseInt(input.dataset.numValue) || parseInt(input.value.replace(/[^0-9]/g, '')) || 0;
                        if (varName && numValue > 0) {
                            variables[varName] = numValue;
                        }
                    });
                    return variables;
                },

                collectAccountMappings() {
                    const mappings = {};
                    document.querySelectorAll('.account-select').forEach(select => {
                        const lineOrder = select.dataset.lineOrder;
                        const accountId = select.value;
                        if (lineOrder && accountId) {
                            mappings[lineOrder] = accountId;
                        }
                    });
                    return mappings;
                },

                validateForm() {
                    if (!this.form.transactionDate || !this.form.description) {
                        return 'Tanggal dan keterangan wajib diisi';
                    }
                    if (this.isDetailed) {
                        const variables = this.collectVariables();
                        if (Object.keys(variables).length === 0) {
                            return 'Minimal satu akun harus memiliki nilai';
                        }
                    } else if (!this.form.amount) {
                        return 'Jumlah wajib diisi';
                    }
                    // Validate dynamic account selections
                    const accountSelects = document.querySelectorAll('.account-select');
                    for (const select of accountSelects) {
                        if (!select.value) {
                            return 'Semua akun dinamis harus dipilih';
                        }
                    }
                    return null;
                },

                buildRequestBody() {
                    const body = {
                        transactionDate: this.form.transactionDate,
                        description: this.form.description
                    };
                    if (this.isDetailed) {
                        body.variables = this.collectVariables();
                        body.amount = 0;
                    } else {
                        body.amount = this.form.amount;
                    }
                    // Include account mappings for dynamic accounts
                    const accountMappings = this.collectAccountMappings();
                    if (Object.keys(accountMappings).length > 0) {
                        body.accountMappings = accountMappings;
                    }
                    return body;
                },

                async previewExecution() {
                    this.error = false;
                    this.success = false;

                    const validationError = this.validateForm();
                    if (validationError) {
                        this.error = true;
                        this.errorMessage = validationError;
                        return;
                    }

                    this.loading = true;
                    const templateId = document.getElementById('template-id').value;

                    try {
                        const response = await fetch(`/templates/api/${templateId}/preview`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.buildRequestBody())
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.message || 'Failed to preview');
                        }

                        if (!data.valid) {
                            throw new Error(data.errors.join(', '));
                        }

                        this.previewData = data;
                        this.preview = true;
                    } catch (err) {
                        this.error = true;
                        this.errorMessage = err.message;
                    } finally {
                        this.loading = false;
                    }
                },

                async executeTemplate() {
                    this.loading = true;
                    this.error = false;
                    const templateId = document.getElementById('template-id').value;

                    try {
                        const response = await fetch(`/templates/api/${templateId}/execute`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.buildRequestBody())
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.message || 'Failed to execute template');
                        }

                        // Redirect to transaction detail page
                        window.location.href = `/transactions/${data.transactionId}?created=true`;
                    } catch (err) {
                        this.error = true;
                        this.errorMessage = err.message;
                        this.loading = false;
                    }
                }
            }
        }
    </script>
</body>
</html>
