<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main}"
      lang="id">
<head>
    <title th:text="'Production Order - ' + ${order.orderNumber}">Detail Production Order</title>
</head>
<body>
    <h1 layout:fragment="page-title" th:text="'Production Order: ' + ${order.orderNumber}">Detail Production Order</h1>

    <div layout:fragment="content" class="h-full flex flex-col overflow-y-auto">
        <div class="max-w-4xl">
            <!-- Alerts -->
            <div th:if="${success}" class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded">
                <span th:text="${success}"></span>
            </div>
            <div th:if="${error}" class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
                <span th:text="${error}"></span>
            </div>

            <!-- Basic Info -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-medium text-gray-900">Informasi Order</h2>
                    <span th:switch="${order.status.name()}">
                        <span th:case="'DRAFT'" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">Draft</span>
                        <span th:case="'IN_PROGRESS'" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">Sedang Diproses</span>
                        <span th:case="'COMPLETED'" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800" data-testid="order-status-completed">Selesai</span>
                        <span th:case="'CANCELLED'" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">Dibatalkan</span>
                    </span>
                </div>
                <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">No. Order</dt>
                        <dd class="mt-1 text-sm text-gray-900" th:text="${order.orderNumber}" data-testid="order-number">PO-2025-0001</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Tanggal Order</dt>
                        <dd class="mt-1 text-sm text-gray-900" th:text="${#temporals.format(order.orderDate, 'dd MMMM yyyy')}">01 Januari 2025</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">BOM</dt>
                        <dd class="mt-1 text-sm text-gray-900" th:text="${order.billOfMaterial.code + ' - ' + order.billOfMaterial.name}">BOM-001</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Produk Jadi</dt>
                        <dd class="mt-1 text-sm text-gray-900" th:text="${order.billOfMaterial.product.code + ' - ' + order.billOfMaterial.product.name}" data-testid="product-name">Produk A</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Jumlah Produksi</dt>
                        <dd class="mt-1 text-sm text-gray-900" th:text="${#numbers.formatDecimal(order.quantity, 0, 'COMMA', 2, 'POINT')} + ' ' + ${order.billOfMaterial.product.unit}">10 pcs</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Target Selesai</dt>
                        <dd class="mt-1 text-sm text-gray-900" th:text="${order.plannedCompletionDate != null ? #temporals.format(order.plannedCompletionDate, 'dd MMMM yyyy') : '-'}">-</dd>
                    </div>
                    <div th:if="${order.actualCompletionDate != null}">
                        <dt class="text-sm font-medium text-gray-500">Tanggal Selesai</dt>
                        <dd class="mt-1 text-sm text-gray-900" th:text="${#temporals.format(order.actualCompletionDate, 'dd MMMM yyyy')}">01 Januari 2025</dd>
                    </div>
                    <div th:if="${order.notes}" class="md:col-span-2">
                        <dt class="text-sm font-medium text-gray-500">Catatan</dt>
                        <dd class="mt-1 text-sm text-gray-900" th:text="${order.notes}">-</dd>
                    </div>
                </dl>
            </div>

            <!-- Cost Summary (shown only for completed orders) -->
            <div th:if="${order.status.name() == 'COMPLETED'}" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Ringkasan Biaya</h2>
                <dl class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <dt class="text-sm font-medium text-gray-500">Total Biaya Komponen</dt>
                        <dd class="mt-1 text-2xl font-semibold text-gray-900" th:text="'Rp ' + ${#numbers.formatDecimal(order.totalComponentCost, 0, 'COMMA', 0, 'POINT')}" data-testid="order-total-cost">Rp 1.000.000</dd>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <dt class="text-sm font-medium text-gray-500">Jumlah Produksi</dt>
                        <dd class="mt-1 text-2xl font-semibold text-gray-900" th:text="${#numbers.formatDecimal(order.quantity, 0, 'COMMA', 2, 'POINT')} + ' ' + ${order.billOfMaterial.product.unit}" data-testid="order-quantity">10 pcs</dd>
                    </div>
                    <div class="bg-primary-50 rounded-lg p-4">
                        <dt class="text-sm font-medium text-primary-700">Harga Pokok per Unit</dt>
                        <dd class="mt-1 text-2xl font-semibold text-primary-900" th:text="'Rp ' + ${#numbers.formatDecimal(order.unitCost, 0, 'COMMA', 2, 'POINT')}" data-testid="order-unit-cost">Rp 100.000</dd>
                    </div>
                </dl>
            </div>

            <!-- Components Required -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Komponen yang Dibutuhkan</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Kode</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nama Komponen</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Kebutuhan per BOM</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total Kebutuhan</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Satuan</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr th:each="line, stat : ${order.billOfMaterial.lines}"
                                th:with="multiplier=${order.quantity.divide(order.billOfMaterial.outputQuantity, 4, T(java.math.RoundingMode).HALF_UP)}">
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500" th:text="${stat.index + 1}">1</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900" th:text="${line.component.code}">CMP-001</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900" th:text="${line.component.name}">Komponen A</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 text-right" th:text="${#numbers.formatDecimal(line.quantity, 0, 'COMMA', 2, 'POINT')}">10</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 text-right font-medium" th:text="${#numbers.formatDecimal(line.quantity.multiply(multiplier), 0, 'COMMA', 2, 'POINT')}">100</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500" th:text="${line.component.unit}">pcs</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Audit Info -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Informasi Audit</h2>
                <dl class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <dt class="font-medium text-gray-500">Dibuat oleh</dt>
                        <dd class="mt-1 text-gray-900" th:text="${order.createdBy ?: '-'}">admin</dd>
                    </div>
                    <div>
                        <dt class="font-medium text-gray-500">Tanggal dibuat</dt>
                        <dd class="mt-1 text-gray-900" th:text="${#temporals.format(order.createdAt, 'dd MMM yyyy HH:mm')}">01 Jan 2025 10:00</dd>
                    </div>
                    <div th:if="${order.completedBy != null}">
                        <dt class="font-medium text-gray-500">Diselesaikan oleh</dt>
                        <dd class="mt-1 text-gray-900" th:text="${order.completedBy}">admin</dd>
                    </div>
                </dl>
            </div>

            <!-- Actions -->
            <div class="flex justify-between">
                <a th:href="@{/inventory/production}" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Kembali</a>
                <div class="flex gap-3">
                    <!-- Edit (only for DRAFT) -->
                    <a th:if="${order.status.name() == 'DRAFT'}" th:href="@{/inventory/production/{id}/edit(id=${order.id})}"
                       class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700">Edit</a>

                    <!-- Start Production (only for DRAFT) -->
                    <form th:if="${order.status.name() == 'DRAFT'}" id="form-start" th:action="@{/inventory/production/{id}/start(id=${order.id})}" method="post" class="inline">
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Mulai Produksi</button>
                    </form>

                    <!-- Complete Production (only for IN_PROGRESS) -->
                    <form th:if="${order.status.name() == 'IN_PROGRESS'}" id="form-complete" th:action="@{/inventory/production/{id}/complete(id=${order.id})}" method="post" class="inline">
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Selesaikan Produksi</button>
                    </form>

                    <!-- Cancel (for DRAFT or IN_PROGRESS) -->
                    <form th:if="${order.status.name() == 'DRAFT' || order.status.name() == 'IN_PROGRESS'}" id="form-cancel"
                          th:action="@{/inventory/production/{id}/cancel(id=${order.id})}" method="post" class="inline">
                        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Batalkan</button>
                    </form>

                    <!-- Delete (only for DRAFT) -->
                    <form th:if="${order.status.name() == 'DRAFT'}" id="form-delete" th:action="@{/inventory/production/{id}/delete(id=${order.id})}" method="post" class="inline">
                        <button type="submit" class="px-4 py-2 border border-red-300 text-red-600 rounded-md hover:bg-red-50">Hapus</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <th:block layout:fragment="scripts">
        <script th:inline="javascript" th:attr="nonce=${cspNonce}">
            document.getElementById('form-start')?.addEventListener('submit', function(e) {
                if (!confirm('Mulai produksi? Pastikan semua komponen tersedia.')) e.preventDefault();
            });
            document.getElementById('form-complete')?.addEventListener('submit', function(e) {
                if (!confirm('Selesaikan produksi? Komponen akan dikurangi dari stok dan produk jadi akan ditambahkan.')) e.preventDefault();
            });
            document.getElementById('form-cancel')?.addEventListener('submit', function(e) {
                if (!confirm('Yakin ingin membatalkan order ini?')) e.preventDefault();
            });
            document.getElementById('form-delete')?.addEventListener('submit', function(e) {
                if (!confirm('Yakin ingin menghapus order ini?')) e.preventDefault();
            });
        </script>
    </th:block>
</body>
</html>
