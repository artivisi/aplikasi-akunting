<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main}"
      lang="id">
<head>
    <title th:text="${isEdit} ? 'Edit Transaksi' : 'Transaksi Baru'">Transaksi</title>
</head>
<body>
    <h1 id="page-title" layout:fragment="page-title" th:text="${isEdit} ? 'Edit Transaksi' : 'Transaksi Baru'">Transaksi</h1>

    <div id="transaction-form-content" layout:fragment="content" class="h-full flex flex-col overflow-y-auto">
        <div class="max-w-4xl">
            <!-- Breadcrumb -->
            <nav class="flex items-center space-x-2 text-sm text-gray-500 mb-6">
                <a th:href="@{/transactions}" class="hover:text-primary-600 transition-colors">Transaksi</a>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                <span class="text-gray-900" th:text="${isEdit} ? 'Edit Transaksi' : 'Transaksi Baru'">Transaksi</span>
            </nav>

            <!-- No Template Selected State -->
            <div th:if="${selectedTemplate == null and !isEdit}" class="mb-6 p-6 bg-amber-50 rounded-lg border border-amber-200">
                <div class="text-center">
                    <svg class="w-12 h-12 text-amber-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h3 class="text-lg font-semibold text-amber-800 mb-2">Pilih Template</h3>
                    <p class="text-sm text-amber-600 mb-4">Pilih template jurnal untuk membuat transaksi baru</p>
                    <div class="flex flex-wrap justify-center gap-2">
                        <a th:each="tpl : ${templates}"
                           th:href="@{/transactions/new(templateId=${tpl.id})}"
                           th:classappend="${tpl.category.name() == 'INCOME'} ? 'border-green-300 hover:bg-green-50' : (${tpl.category.name() == 'EXPENSE'} ? 'border-red-300 hover:bg-red-50' : (${tpl.category.name() == 'TRANSFER'} ? 'border-purple-300 hover:bg-purple-50' : 'border-blue-300 hover:bg-blue-50'))"
                           class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border rounded-lg transition-colors">
                            <span th:classappend="${tpl.category.name() == 'INCOME'} ? 'bg-green-500' : (${tpl.category.name() == 'EXPENSE'} ? 'bg-red-500' : (${tpl.category.name() == 'TRANSFER'} ? 'bg-purple-500' : 'bg-blue-500'))"
                                  class="w-2 h-2 rounded-full mr-2"></span>
                            <span th:text="${tpl.templateName}">Template</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Template Info Card (for new transactions with selected template) -->
            <div th:if="${selectedTemplate != null and !isEdit}" class="mb-6 p-4 rounded-lg border"
                 th:classappend="${selectedTemplate.category.name() == 'INCOME'} ? 'bg-green-50 border-green-200' : (${selectedTemplate.category.name() == 'EXPENSE'} ? 'bg-red-50 border-red-200' : (${selectedTemplate.category.name() == 'TRANSFER'} ? 'bg-purple-50 border-purple-200' : 'bg-blue-50 border-blue-200'))">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg th:classappend="${selectedTemplate.category.name() == 'INCOME'} ? 'text-green-600' : (${selectedTemplate.category.name() == 'EXPENSE'} ? 'text-red-600' : (${selectedTemplate.category.name() == 'TRANSFER'} ? 'text-purple-600' : 'text-blue-600'))"
                             class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6z"/>
                        </svg>
                    </div>
                    <div class="ml-3 flex-1">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 th:classappend="${selectedTemplate.category.name() == 'INCOME'} ? 'text-green-800' : (${selectedTemplate.category.name() == 'EXPENSE'} ? 'text-red-800' : (${selectedTemplate.category.name() == 'TRANSFER'} ? 'text-purple-800' : 'text-blue-800'))"
                                    class="text-sm font-semibold">
                                    Template: <span th:text="${selectedTemplate.templateName}">Template Name</span>
                                </h3>
                                <p th:classappend="${selectedTemplate.category.name() == 'INCOME'} ? 'text-green-600' : (${selectedTemplate.category.name() == 'EXPENSE'} ? 'text-red-600' : (${selectedTemplate.category.name() == 'TRANSFER'} ? 'text-purple-600' : 'text-blue-600'))"
                                   class="text-xs mt-0.5">
                                    Kategori:
                                    <span th:text="${selectedTemplate.category.name() == 'INCOME'} ? 'Pendapatan' : (${selectedTemplate.category.name() == 'EXPENSE'} ? 'Pengeluaran' : (${selectedTemplate.category.name() == 'PAYMENT'} ? 'Pembayaran' : (${selectedTemplate.category.name() == 'RECEIPT'} ? 'Penerimaan' : 'Transfer')))">Category</span>
                                    <span th:if="${selectedTemplate.cashFlowCategory != null}">
                                        | Cash Flow: <span th:text="${selectedTemplate.cashFlowCategory.name()}">Operating</span>
                                    </span>
                                </p>
                            </div>
                            <a th:href="@{/transactions/new}" th:classappend="${selectedTemplate.category.name() == 'INCOME'} ? 'text-green-700 hover:text-green-900' : (${selectedTemplate.category.name() == 'EXPENSE'} ? 'text-red-700 hover:text-red-900' : (${selectedTemplate.category.name() == 'TRANSFER'} ? 'text-purple-700 hover:text-purple-900' : 'text-blue-700 hover:text-blue-900'))"
                               class="text-xs underline">Ganti Template</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Form Card (only show when template is selected or editing) -->
            <div th:if="${selectedTemplate != null or isEdit}" class="bg-white rounded-lg shadow-sm border border-gray-200">
                <form id="form-transaksi" th:action="@{/transactions}" method="post"
                      x-data="{
                          amount: /*[[${isEdit and transaction != null ? transaction.amount : 0}]]*/ 0,
                          description: /*[[${isEdit and transaction != null ? transaction.description : ''}]]*/ '',
                          formatCurrency(value) {
                              return new Intl.NumberFormat('id-ID').format(value);
                          },
                          parseCurrency(str) {
                              return parseInt(str.replace(/\D/g, '')) || 0;
                          }
                      }">
                    <!-- Hidden fields -->
                    <input type="hidden" name="templateId" th:value="${selectedTemplate?.id ?: transaction?.journalTemplate?.id}">
                    <input type="hidden" name="id" th:if="${isEdit}" th:value="${transaction?.id}">

                    <!-- Transaction Header Section -->
                    <div class="p-6 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Informasi Transaksi</h2>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Transaction Number -->
                            <div>
                                <label for="transactionNumber" class="block text-sm font-medium text-gray-700 mb-1">
                                    No. Transaksi
                                </label>
                                <input type="text" id="transactionNumber" name="transactionNumber"
                                       th:value="${isEdit ? transaction.transactionNumber : '(Auto-generated)'}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 text-sm"
                                       readonly>
                                <p class="text-xs text-gray-500 mt-1">Nomor otomatis berdasarkan urutan</p>
                            </div>

                            <!-- Transaction Date -->
                            <div>
                                <label for="transactionDate" class="block text-sm font-medium text-gray-700 mb-1">
                                    Tanggal <span class="text-red-500">*</span>
                                </label>
                                <input type="date" id="transactionDate" name="transactionDate"
                                       th:value="${isEdit ? transaction.transactionDate : #temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm"
                                       required>
                            </div>

                            <!-- Amount -->
                            <div>
                                <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">
                                    Jumlah <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">Rp</span>
                                    <input type="text" id="amount" name="amountDisplay"
                                           x-model="amount"
                                           :value="formatCurrency(amount)"
                                           @input="amount = parseCurrency($event.target.value)"
                                           class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm text-right font-mono"
                                           placeholder="0"
                                           required>
                                    <input type="hidden" name="amount" :value="amount">
                                </div>
                            </div>

                            <!-- Source Account (for templates with selectable accounts) -->
                            <div th:if="${selectedTemplate != null and selectedTemplate.lines != null}">
                                <label for="sourceAccount" class="block text-sm font-medium text-gray-700 mb-1">
                                    Akun Sumber <span class="text-red-500">*</span>
                                </label>
                                <select id="sourceAccount" name="sourceAccountId"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm"
                                        required>
                                    <option value="">Pilih akun</option>
                                    <optgroup label="Kas">
                                        <th:block th:each="acc : ${accounts}">
                                            <option th:if="${acc.accountCode.startsWith('1.1.01') or acc.accountCode.contains('Kas')}"
                                                    th:value="${acc.id}"
                                                    th:text="${acc.accountCode + ' - ' + acc.accountName}">Account</option>
                                        </th:block>
                                    </optgroup>
                                    <optgroup label="Bank">
                                        <th:block th:each="acc : ${accounts}">
                                            <option th:if="${acc.accountCode.startsWith('1.1.02') or acc.accountCode.startsWith('1.1.03') or acc.accountName.toLowerCase().contains('bank')}"
                                                    th:value="${acc.id}"
                                                    th:text="${acc.accountCode + ' - ' + acc.accountName}">Account</option>
                                        </th:block>
                                    </optgroup>
                                </select>
                            </div>

                            <!-- Description (full width) -->
                            <div class="md:col-span-2">
                                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
                                    Keterangan <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="description" name="description"
                                       x-model="description"
                                       th:value="${isEdit ? transaction.description : ''}"
                                       placeholder="Contoh: Jasa Konsultasi PT. ABC - Invoice INV-2025-001"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm"
                                       required>
                            </div>

                            <!-- Reference Number -->
                            <div>
                                <label for="referenceNumber" class="block text-sm font-medium text-gray-700 mb-1">
                                    No. Referensi
                                </label>
                                <input type="text" id="referenceNumber" name="referenceNumber"
                                       th:value="${isEdit ? transaction.referenceNumber : ''}"
                                       placeholder="Contoh: INV-2025-001, PO-001"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm">
                            </div>

                            <!-- Notes -->
                            <div>
                                <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">
                                    Catatan
                                </label>
                                <input type="text" id="notes" name="notes"
                                       th:value="${isEdit ? transaction.notes : ''}"
                                       placeholder="Catatan tambahan (opsional)"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm">
                            </div>
                        </div>
                    </div>

                    <!-- Journal Entry Preview Section -->
                    <div id="journal-preview" class="p-6 border-b border-gray-200 bg-gray-50">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold text-gray-900">Preview Jurnal</h2>
                            <span class="text-xs text-gray-500">Jurnal akan dibuat otomatis berdasarkan template</span>
                        </div>

                        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                            <!-- Journal Header -->
                            <div class="grid grid-cols-12 gap-4 px-4 py-2 bg-gray-100 text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <div class="col-span-1">Kode</div>
                                <div class="col-span-5">Nama Akun</div>
                                <div class="col-span-3 text-right">Debit</div>
                                <div class="col-span-3 text-right">Kredit</div>
                            </div>

                            <!-- Journal Lines from Template -->
                            <div class="divide-y divide-gray-100" th:if="${selectedTemplate != null and selectedTemplate.lines != null}">
                                <div th:each="line : ${selectedTemplate.lines}" class="grid grid-cols-12 gap-4 px-4 py-3 items-center">
                                    <div class="col-span-1 text-sm text-gray-600 font-mono" th:text="${line.account?.accountCode}">1.1.01</div>
                                    <div class="col-span-5 text-sm text-gray-800" th:text="${line.account?.accountName}">Account Name</div>
                                    <div class="col-span-3 text-right text-sm font-mono"
                                         th:classappend="${line.position.name() == 'DEBIT'} ? 'text-gray-900' : 'text-gray-400'">
                                        <span th:if="${line.position.name() == 'DEBIT'}">Rp <span x-text="formatCurrency(amount)">0</span></span>
                                        <span th:unless="${line.position.name() == 'DEBIT'}">-</span>
                                    </div>
                                    <div class="col-span-3 text-right text-sm font-mono"
                                         th:classappend="${line.position.name() == 'CREDIT'} ? 'text-gray-900' : 'text-gray-400'">
                                        <span th:if="${line.position.name() == 'CREDIT'}">Rp <span x-text="formatCurrency(amount)">0</span></span>
                                        <span th:unless="${line.position.name() == 'CREDIT'}">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Journal Lines for Edit Mode -->
                            <div class="divide-y divide-gray-100" th:if="${isEdit and transaction != null and transaction.journalTemplate != null and transaction.journalTemplate.lines != null}">
                                <div th:each="line : ${transaction.journalTemplate.lines}" class="grid grid-cols-12 gap-4 px-4 py-3 items-center">
                                    <div class="col-span-1 text-sm text-gray-600 font-mono" th:text="${line.account?.accountCode}">1.1.01</div>
                                    <div class="col-span-5 text-sm text-gray-800" th:text="${line.account?.accountName}">Account Name</div>
                                    <div class="col-span-3 text-right text-sm font-mono"
                                         th:classappend="${line.position.name() == 'DEBIT'} ? 'text-gray-900' : 'text-gray-400'">
                                        <span th:if="${line.position.name() == 'DEBIT'}">Rp <span x-text="formatCurrency(amount)">0</span></span>
                                        <span th:unless="${line.position.name() == 'DEBIT'}">-</span>
                                    </div>
                                    <div class="col-span-3 text-right text-sm font-mono"
                                         th:classappend="${line.position.name() == 'CREDIT'} ? 'text-gray-900' : 'text-gray-400'">
                                        <span th:if="${line.position.name() == 'CREDIT'}">Rp <span x-text="formatCurrency(amount)">0</span></span>
                                        <span th:unless="${line.position.name() == 'CREDIT'}">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Journal Totals -->
                            <div class="grid grid-cols-12 gap-4 px-4 py-3 bg-gray-50 border-t border-gray-200">
                                <div class="col-span-6 text-sm font-semibold text-gray-700">Total</div>
                                <div class="col-span-3 text-right text-sm font-mono font-semibold text-gray-900">
                                    Rp <span x-text="formatCurrency(amount)">0</span>
                                </div>
                                <div class="col-span-3 text-right text-sm font-mono font-semibold text-gray-900">
                                    Rp <span x-text="formatCurrency(amount)">0</span>
                                </div>
                            </div>

                            <!-- Balance Check -->
                            <div class="px-4 py-2 bg-accent-50 border-t border-accent-200">
                                <div class="flex items-center text-xs text-accent-700">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Jurnal Balance (Debit = Kredit)
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Document Attachment Section (Phase 2 placeholder) -->
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold text-gray-900">Lampiran Dokumen</h2>
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600">
                                Coming Soon
                            </span>
                        </div>

                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <p class="mt-2 text-sm text-gray-500">Fitur upload dokumen akan tersedia di fase berikutnya</p>
                            <p class="text-xs text-gray-400 mt-1">Sementara simpan bukti transaksi di folder eksternal</p>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="p-6 bg-gray-50 rounded-b-lg flex items-center justify-between">
                        <a th:href="@{/transactions}"
                           class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 transition-colors">
                            Batal
                        </a>
                        <div class="flex items-center space-x-3">
                            <!-- Save as Draft -->
                            <button id="btn-simpan-draft" type="button"
                                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                                    </svg>
                                    Simpan Draft
                                </span>
                            </button>

                            <!-- Save and Post -->
                            <button id="btn-simpan-posting" type="button"
                                    class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 transition-colors">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Simpan &amp; Posting
                                </span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Help Section -->
            <div x-data="{ open: false }" class="mt-6 mb-8" th:if="${selectedTemplate != null or isEdit}">
                <button @click="open = !open"
                        class="flex items-center text-sm text-gray-600 hover:text-gray-900 transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Bantuan Pengisian Transaksi
                </button>

                <div x-show="open" x-collapse class="mt-3 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs text-blue-800">
                        <div>
                            <h4 class="font-semibold mb-2">Status Transaksi</h4>
                            <ul class="space-y-1">
                                <li><span class="font-medium">Draft:</span> Transaksi tersimpan tapi belum mempengaruhi saldo</li>
                                <li><span class="font-medium">Posted:</span> Transaksi sudah diposting ke jurnal</li>
                                <li><span class="font-medium">Void:</span> Transaksi dibatalkan</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">Tips</h4>
                            <ul class="space-y-1">
                                <li>Gunakan "Simpan Draft" jika belum yakin dengan data</li>
                                <li>Transaksi yang sudah Posted tidak bisa diedit</li>
                                <li>Gunakan Void untuk membatalkan transaksi Posted</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Script for form submission -->
    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('form-transaksi');
                if (!form) return;

                const templateId = /*[[${selectedTemplate?.id ?: (transaction?.journalTemplate?.id ?: '')}]]*/ '';
                const transactionId = /*[[${isEdit and transaction != null ? transaction.id : ''}]]*/ '';
                const isEdit = /*[[${isEdit}]]*/ false;

                function getFormData() {
                    return {
                        templateId: templateId,
                        transactionDate: document.getElementById('transactionDate').value,
                        amount: parseInt(document.querySelector('input[name="amount"]').value) || 0,
                        description: document.getElementById('description').value,
                        referenceNumber: document.getElementById('referenceNumber')?.value || '',
                        notes: document.getElementById('notes')?.value || '',
                        accountMappings: {}
                    };
                }

                // Save Draft
                document.getElementById('btn-simpan-draft')?.addEventListener('click', async function() {
                    const data = getFormData();
                    console.log('Saving draft with data:', JSON.stringify(data));

                    try {
                        let response;
                        if (isEdit && transactionId) {
                            response = await fetch(`/transactions/api/${transactionId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data)
                            });
                        } else {
                            response = await fetch('/transactions/api', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data)
                            });
                        }

                        console.log('Response status:', response.status);
                        if (response.ok) {
                            const result = await response.json();
                            console.log('Response data:', JSON.stringify(result));
                            window.location.href = `/transactions/${result.id}`;
                        } else {
                            const errorText = await response.text();
                            console.error('Error response:', errorText);
                            alert('Gagal menyimpan: ' + errorText);
                        }
                    } catch (err) {
                        console.error('Exception:', err);
                        alert('Gagal menyimpan: ' + err.message);
                    }
                });

                // Save and Post
                document.getElementById('btn-simpan-posting')?.addEventListener('click', async function() {
                    const data = getFormData();

                    try {
                        // First create/update the transaction
                        let createResponse;
                        if (isEdit && transactionId) {
                            createResponse = await fetch(`/transactions/api/${transactionId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data)
                            });
                        } else {
                            createResponse = await fetch('/transactions/api', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data)
                            });
                        }

                        if (!createResponse.ok) {
                            const error = await createResponse.json();
                            alert('Gagal menyimpan: ' + (error.message || 'Unknown error'));
                            return;
                        }

                        const result = await createResponse.json();

                        // Then post it
                        const postResponse = await fetch(`/transactions/api/${result.id}/post`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        if (postResponse.ok) {
                            window.location.href = `/transactions/${result.id}`;
                        } else {
                            const error = await postResponse.json();
                            alert('Gagal posting: ' + (error.message || 'Unknown error'));
                            // Still redirect to show the draft
                            window.location.href = `/transactions/${result.id}`;
                        }
                    } catch (err) {
                        alert('Gagal menyimpan: ' + err.message);
                    }
                });
            });
        </script>
    </th:block>
</body>
</html>
