<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main}"
      lang="id">
<head>
    <title>Laporan Rekonsiliasi</title>
</head>
<body>
    <h1 id="page-title" layout:fragment="page-title">Laporan Rekonsiliasi Bank</h1>

    <div layout:fragment="content">
        <!-- Actions -->
        <div class="flex gap-2 mb-6">
            <a th:href="@{/bank-reconciliation/reconciliations/{id}/report/print(id=${recon.id})}" target="_blank"
               data-testid="btn-print"
               class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm">Cetak</a>
            <a th:href="@{/bank-reconciliation/reconciliations/{id}(id=${recon.id})}"
               class="px-4 py-2 text-gray-600 hover:text-gray-900 text-sm">Kembali</a>
        </div>

        <!-- Summary -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Ringkasan</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500">Total Item</p>
                    <p class="text-lg font-medium" th:text="${summary['totalItems']}">0</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg">
                    <p class="text-xs text-gray-500">Cocok</p>
                    <p class="text-lg font-medium text-green-700" th:text="${summary['matchedCount']}">0</p>
                </div>
                <div class="p-4 bg-orange-50 rounded-lg">
                    <p class="text-xs text-gray-500">Hanya di Bank</p>
                    <p class="text-lg font-medium text-orange-700" th:text="${summary['bankOnlyCount']}">0</p>
                </div>
                <div class="p-4 bg-purple-50 rounded-lg">
                    <p class="text-xs text-gray-500">Hanya di Buku</p>
                    <p class="text-lg font-medium text-purple-700" th:text="${summary['bookOnlyCount']}">0</p>
                </div>
                <div class="p-4 bg-blue-50 rounded-lg">
                    <p class="text-xs text-gray-500">Saldo Buku</p>
                    <p class="text-lg font-medium font-mono" th:text="${#numbers.formatDecimal(summary['bookBalance'], 0, 'COMMA', 0, 'POINT')}">0</p>
                </div>
                <div class="p-4 bg-blue-50 rounded-lg">
                    <p class="text-xs text-gray-500">Saldo Bank</p>
                    <p class="text-lg font-medium font-mono" th:text="${#numbers.formatDecimal(summary['bankBalance'], 0, 'COMMA', 0, 'POINT')}">0</p>
                </div>
            </div>
        </div>

        <!-- Reconciliation Statement -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Laporan Rekonsiliasi</h2>
            <table class="w-full" data-testid="reconciliation-statement">
                <thead class="sr-only">
                    <tr><th>Keterangan</th><th>Jumlah</th></tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    <tr>
                        <td class="py-2 text-sm font-medium">Saldo per Buku Besar</td>
                        <td class="py-2 text-sm text-right font-mono" th:text="${#numbers.formatDecimal(statement['bookBalance'], 0, 'COMMA', 2, 'POINT')}">0</td>
                    </tr>
                    <tr>
                        <td class="py-2 text-sm text-gray-600 pl-4">+ Kredit hanya di bank (belum tercatat di buku)</td>
                        <td class="py-2 text-sm text-right font-mono text-green-600" th:text="${#numbers.formatDecimal(statement['bankOnlyCreditTotal'], 0, 'COMMA', 2, 'POINT')}">0</td>
                    </tr>
                    <tr>
                        <td class="py-2 text-sm text-gray-600 pl-4">- Debit hanya di bank (belum tercatat di buku)</td>
                        <td class="py-2 text-sm text-right font-mono text-red-600" th:text="${#numbers.formatDecimal(statement['bankOnlyDebitTotal'], 0, 'COMMA', 2, 'POINT')}">0</td>
                    </tr>
                    <tr class="font-medium border-t-2 border-gray-300">
                        <td class="py-2 text-sm">Saldo Buku Disesuaikan</td>
                        <td class="py-2 text-sm text-right font-mono" th:text="${#numbers.formatDecimal(statement['adjustedBookBalance'], 0, 'COMMA', 2, 'POINT')}">0</td>
                    </tr>
                    <tr class="border-t-4 border-gray-400">
                        <td class="py-2 text-sm font-medium">Saldo per Bank</td>
                        <td class="py-2 text-sm text-right font-mono" th:text="${#numbers.formatDecimal(statement['bankBalance'], 0, 'COMMA', 2, 'POINT')}">0</td>
                    </tr>
                    <tr>
                        <td class="py-2 text-sm text-gray-600 pl-4">+ Transaksi hanya di buku (belum tercatat di bank)</td>
                        <td class="py-2 text-sm text-right font-mono text-green-600" th:text="${#numbers.formatDecimal(statement['bookOnlyTotal'], 0, 'COMMA', 2, 'POINT')}">0</td>
                    </tr>
                    <tr class="font-medium border-t-2 border-gray-300">
                        <td class="py-2 text-sm">Saldo Bank Disesuaikan</td>
                        <td class="py-2 text-sm text-right font-mono" th:text="${#numbers.formatDecimal(statement['adjustedBankBalance'], 0, 'COMMA', 2, 'POINT')}">0</td>
                    </tr>
                    <tr class="border-t-4 border-gray-400">
                        <td class="py-3 text-base font-bold">Selisih</td>
                        <td class="py-3 text-base text-right font-mono font-bold"
                            th:text="${#numbers.formatDecimal(statement['difference'], 0, 'COMMA', 2, 'POINT')}"
                            th:classappend="${statement['difference'].compareTo(T(java.math.BigDecimal).ZERO) != 0} ? 'text-red-600' : 'text-green-600'">0</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Outstanding Items -->
        <div class="bg-white rounded-lg shadow" th:if="${outstanding != null && !outstanding.isEmpty()}">
            <div class="px-6 py-4 border-b">
                <h2 class="text-lg font-medium text-gray-900">Item Outstanding</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" data-testid="outstanding-items-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipe</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Deskripsi</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Catatan</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <tr th:each="item : ${outstanding}">
                            <td class="px-6 py-4">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                                      th:classappend="${item.matchStatus.name() == 'BANK_ONLY'} ? 'bg-orange-100 text-orange-800' : 'bg-purple-100 text-purple-800'"
                                      th:text="${item.matchStatus.indonesianName}">Type</span>
                            </td>
                            <td class="px-6 py-4 text-sm" th:text="${item.statementItem != null ? #temporals.format(item.statementItem.transactionDate, 'dd/MM/yyyy') : (item.transaction != null ? #temporals.format(item.transaction.transactionDate, 'dd/MM/yyyy') : '-')}">01/01</td>
                            <td class="px-6 py-4 text-sm" th:text="${item.statementItem != null ? item.statementItem.description : (item.transaction != null ? item.transaction.description : '-')}">Desc</td>
                            <td class="px-6 py-4 text-sm text-right font-mono" th:text="${item.statementItem != null ? #numbers.formatDecimal(item.statementItem.netAmount.abs(), 0, 'COMMA', 0, 'POINT') : (item.transaction != null ? #numbers.formatDecimal(item.transaction.amount, 0, 'COMMA', 0, 'POINT') : '-')}">0</td>
                            <td class="px-6 py-4 text-sm text-gray-500" th:text="${item.notes != null ? item.notes : '-'}">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
</html>
