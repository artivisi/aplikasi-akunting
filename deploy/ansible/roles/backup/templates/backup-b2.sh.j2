#!/bin/bash
# Upload backup to Backblaze B2
# Generated by Ansible - do not edit manually

set -e

# Load configuration
CONFIG_FILE="/opt/{{ app_name }}/backup.conf"
if [ ! -f "${CONFIG_FILE}" ]; then
    echo "ERROR: Config file not found: ${CONFIG_FILE}"
    exit 1
fi
source "${CONFIG_FILE}"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] B2: $1" | tee -a "${LOG_FILE}"
}

if [ "${BACKUP_B2_ENABLED}" != "true" ]; then
    log "B2 backup is disabled in config"
    exit 0
fi

if [ -z "${BACKUP_B2_BUCKET}" ]; then
    log "ERROR: BACKUP_B2_BUCKET is not configured"
    exit 1
fi

# Get latest backup
BACKUP_FILE=$(ls -t "${BACKUP_DIR}"/*.tar.gz 2>/dev/null | head -1)

if [ -z "${BACKUP_FILE}" ]; then
    log "ERROR: No backup file found"
    exit 1
fi

BASENAME=$(basename "${BACKUP_FILE}")
ENCRYPTED_FILE="/tmp/${BASENAME}.gpg"

log "Starting B2 upload: ${BASENAME}"

# Encrypt backup
log "Encrypting backup..."
if ! gpg --symmetric --cipher-algo AES256 \
    --passphrase-file "${BACKUP_KEY}" \
    --batch --yes \
    -o "${ENCRYPTED_FILE}" "${BACKUP_FILE}"; then
    log "ERROR: Encryption failed"
    exit 1
fi

# Upload to B2
log "Uploading to B2 bucket: ${BACKUP_B2_BUCKET}"
if ! rclone copy "${ENCRYPTED_FILE}" "${RCLONE_B2_REMOTE}:${BACKUP_B2_BUCKET}/" --log-file="${LOG_FILE}" --log-level=INFO; then
    log "ERROR: B2 upload failed"
    rm -f "${ENCRYPTED_FILE}"
    exit 1
fi

# Cleanup local encrypted file
rm -f "${ENCRYPTED_FILE}"

# Remove old backups from B2 (older than retention period)
RETENTION_DAYS=$((BACKUP_B2_RETENTION_WEEKS * 7))
log "Cleaning up backups older than ${RETENTION_DAYS} days from B2..."
rclone delete "${RCLONE_B2_REMOTE}:${BACKUP_B2_BUCKET}/" --min-age "${RETENTION_DAYS}d" --log-file="${LOG_FILE}" --log-level=INFO 2>/dev/null || true

log "B2 upload completed: ${BASENAME}.gpg"
