#!/bin/bash
# Upload backup to Google Drive
# Generated by Ansible - do not edit manually

set -e

# Set rclone config location for system user
export RCLONE_CONFIG="/opt/{{ app_name }}/.config/rclone/rclone.conf"

# Set GPG home directory for system user
export GNUPGHOME="/opt/{{ app_name }}/.gnupg"
mkdir -p "${GNUPGHOME}"
chmod 700 "${GNUPGHOME}"

# Load configuration
CONFIG_FILE="/opt/{{ app_name }}/backup.conf"
if [ ! -f "${CONFIG_FILE}" ]; then
    echo "ERROR: Config file not found: ${CONFIG_FILE}"
    exit 1
fi
source "${CONFIG_FILE}"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] GDrive: $1" | tee -a "${LOG_FILE}"
}

if [ "${BACKUP_GDRIVE_ENABLED}" != "true" ]; then
    log "Google Drive backup is disabled in config"
    exit 0
fi

# Get latest backup
BACKUP_FILE=$(ls -t "${BACKUP_DIR}"/*.tar.gz 2>/dev/null | head -1)

if [ -z "${BACKUP_FILE}" ]; then
    log "ERROR: No backup file found"
    exit 1
fi

BASENAME=$(basename "${BACKUP_FILE}")
ENCRYPTED_FILE="/tmp/${BASENAME}.gpg"

log "Starting Google Drive upload: ${BASENAME}"

# Encrypt backup
log "Encrypting backup..."
if ! gpg --symmetric --cipher-algo AES256 \
    --passphrase-file "${BACKUP_KEY}" \
    --batch --yes \
    -o "${ENCRYPTED_FILE}" "${BACKUP_FILE}"; then
    log "ERROR: Encryption failed"
    exit 1
fi

# Upload to Google Drive
log "Uploading to Google Drive: ${BACKUP_GDRIVE_FOLDER}"
if ! rclone copy "${ENCRYPTED_FILE}" "${RCLONE_GDRIVE_REMOTE}:${BACKUP_GDRIVE_FOLDER}/" --log-file="${LOG_FILE}" --log-level=INFO; then
    log "ERROR: Google Drive upload failed"
    rm -f "${ENCRYPTED_FILE}"
    exit 1
fi

# Cleanup local encrypted file
rm -f "${ENCRYPTED_FILE}"

# Remove old backups (older than retention period)
RETENTION_DAYS=$((BACKUP_GDRIVE_RETENTION_MONTHS * 30))
log "Cleaning up backups older than ${RETENTION_DAYS} days from Google Drive..."
rclone delete "${RCLONE_GDRIVE_REMOTE}:${BACKUP_GDRIVE_FOLDER}/" --min-age "${RETENTION_DAYS}d" --log-file="${LOG_FILE}" --log-level=INFO 2>/dev/null || true

log "Google Drive upload completed: ${BASENAME}.gpg"
