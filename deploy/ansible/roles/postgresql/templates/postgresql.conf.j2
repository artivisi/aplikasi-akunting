# PostgreSQL Configuration for Accounting Application
# Generated by Ansible - Do not edit manually
# VPS: s-1vcpu-2gb ({{ pg_server_ram_gb }}GB RAM)

#------------------------------------------------------------------------------
# FILE LOCATIONS
#------------------------------------------------------------------------------

data_directory = '/var/lib/postgresql/{{ postgresql_version }}/main'

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------

listen_addresses = 'localhost'
port = 5432
max_connections = {{ pg_max_connections }}

# SSL
ssl = on
ssl_cert_file = '/etc/ssl/certs/ssl-cert-snakeoil.pem'
ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'

#------------------------------------------------------------------------------
# MEMORY SETTINGS
# Budget: ~256MB for PostgreSQL on shared 2GB server
#------------------------------------------------------------------------------

shared_buffers = {{ pg_shared_buffers }}
effective_cache_size = {{ pg_effective_cache_size }}
work_mem = {{ pg_work_mem }}
maintenance_work_mem = {{ pg_maintenance_work_mem }}

# Huge pages - disable for small servers
huge_pages = off

#------------------------------------------------------------------------------
# QUERY PLANNER
#------------------------------------------------------------------------------

# SSD storage - lower random read cost
{% if pg_storage_type == 'ssd' %}
random_page_cost = 1.1
effective_io_concurrency = 200
{% else %}
random_page_cost = 4.0
effective_io_concurrency = 2
{% endif %}

# Parallel queries - limited for 1 vCPU
max_parallel_workers_per_gather = 1
max_parallel_workers = 2
max_parallel_maintenance_workers = 1

# Default statistics target
default_statistics_target = 100

#------------------------------------------------------------------------------
# WRITE-AHEAD LOG (WAL)
#------------------------------------------------------------------------------

wal_level = replica
wal_buffers = {{ pg_wal_buffers }}

# Checkpoint settings
checkpoint_timeout = 10min
checkpoint_completion_target = {{ pg_checkpoint_completion_target }}
min_wal_size = {{ pg_min_wal_size }}
max_wal_size = {{ pg_max_wal_size }}

# Synchronous commit - keep on for accounting data integrity
synchronous_commit = on

#------------------------------------------------------------------------------
# AUTOVACUUM
#------------------------------------------------------------------------------

autovacuum = on
autovacuum_max_workers = {{ pg_autovacuum_max_workers }}
autovacuum_naptime = {{ pg_autovacuum_naptime }}

# Vacuum when 5% of rows are dead (more aggressive than default 20%)
autovacuum_vacuum_scale_factor = {{ pg_autovacuum_vacuum_scale_factor }}

# Analyze when 2.5% of rows changed (more aggressive than default 10%)
autovacuum_analyze_scale_factor = {{ pg_autovacuum_analyze_scale_factor }}

# Limit autovacuum I/O impact on small server
autovacuum_vacuum_cost_limit = 500

#------------------------------------------------------------------------------
# LOGGING
#------------------------------------------------------------------------------

log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d.log'
log_rotation_age = 1d
log_rotation_size = 50MB
log_truncate_on_rotation = on

# What to log
log_min_duration_statement = {{ pg_log_min_duration_statement }}
log_checkpoints = {{ pg_log_checkpoints }}
log_connections = {{ pg_log_connections }}
log_disconnections = {{ pg_log_disconnections }}
log_lock_waits = {{ pg_log_lock_waits }}
log_temp_files = {{ pg_log_temp_files }}

log_line_prefix = '%t [%p]: user=%u,db=%d,app=%a,client=%h '
log_statement = 'ddl'
log_timezone = 'Asia/Jakarta'

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------

datestyle = 'iso, dmy'
timezone = 'Asia/Jakarta'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'id_ID.UTF-8'
lc_numeric = 'id_ID.UTF-8'
lc_time = 'id_ID.UTF-8'

default_text_search_config = 'pg_catalog.english'

#------------------------------------------------------------------------------
# LOCK MANAGEMENT
#------------------------------------------------------------------------------

# Timeout for acquiring locks (prevent infinite waits)
lock_timeout = 30s
statement_timeout = 60s

# Deadlock detection
deadlock_timeout = 1s
